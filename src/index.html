<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="style.css">
    <title>謹之助リマインダー</title>
</head>
<body>
    <h3>何時に出社しますか?</h3>
    <input  id="attend-time"  type="time"  value="10:00">
    <input  id="attend-status" type="hidden" value="attend">
    <button id="attend-btn">決定</button>

    <script>
            let attend_btn = document.getElementById('attend-btn');

            attend_btn.addEventListener('click', function(){
                let attend_time = document.getElementById('attend-time').value;
                let attend_status = document.getElementById('attend-status').value;
                let attend = [attend_time,attend_status];

                const ipcRenderer = require('electron').ipcRenderer;
                ipcRenderer.send('settings_attend', attend);

            });
    </script>

    <h3>何時に退勤しますか?</h3>
        <input  id="leave-time" type="time" value="19:00">
        <input  id="leave-status" type="hidden" value="leave">
        <button id="leave-btn">決定</button>

        <script>
            let leave_btn = document.getElementById('leave-btn');
            leave_btn.addEventListener('click', function(){
                let leave_time = document.getElementById('leave-time').value;
                let leave_status = document.getElementById('leave-status').value;
                let leave = [leave_time,leave_status];

                const ipcRenderer = require('electron').ipcRenderer;
                ipcRenderer.send('settings_leave', leave);

            });
        </script>
    <h4>デフォルトは19:00にセットされています。</h4>
    <h4>この時間になると通知がされます。</h4>

    <script>
        'use script'

        // ライブラリの読み込み
        const electron = require('electron');
        const ipcRenderer = electron.ipcRenderer;
        const remote = electron.remote;
        const Menu = remote.Menu;
        const MenuItem = remote.MenuItem;
        const shell =remote.shell;

        // BackgroundColor処理
        let color = localStorage.getItem('color') || 'skyblue';
        setBackgroundColor(color);
        clickMenu();

        ipcRenderer.on('set_bgcolor', function(event, color){
            setBackgroundColor(color);
        });


        function clickMenu() {
            let menu = new Menu();
            menu.append(new MenuItem({label: 'Skyblue', click: function(){
                setBackgroundColor('skyblue');
            }}));
            menu.append(new MenuItem({label: 'Tomato', click: function(){
                setBackgroundColor('tomato');
            }}));
            menu.append(new MenuItem({label: 'Slate Gray', click: function(){
                setBackgroundColor('slategray');
            }}));

            window.addEventListener('contextmenu', function(e){
                e.preventDefault();
                // 右クリックでポップアップ表示させる。
                menu.popup(remote.getCurrentWindow());
            });
        }

       function setBackgroundColor(color) {
            document.body.style.backgroundColor = color;
            localStorage.setItem('color', color);
        }

        // リマインダー処理

        //出勤
        ipcRenderer.on('set_attend', function(event, attend){
            console.log("出勤時間は"+attend);
            let attend_time = attend[0];
            let attend_status = attend[1];
            createDate(attend_time);
            let today_date = new Date();
        });

        // 退勤
        ipcRenderer.on('set_leave', function(event, leave){
            console.log("退勤時間は"+leave);
            let leave_time = leave[0];
            let leave_status = leave[1];

            let today_date = new Date();
            // 退勤リマインダー処理
            if( today_date.getTime() > createDate(leave_time) ){
                console.log('現在時刻よりも後ろは設定できないです。');
                let notification = new Notification(
                        '勤之助リマインダー',
                        { body: "【退勤】現在時刻よりも後ろは設定できないです。" }
                );
            } else {
                notifiSetTime(leave_time, leave_status);
                remindLeaveTime(today_date,leave_time)
            }
        });

        function createDate(send_time){
            let tmp = send_time.split(':');
            let hour = tmp[0];
            let minute = tmp[1];

            // 送らてきた時刻のフォーマット修正
            let date = new Date();
            date.setHours(hour);
            date.setMinutes(minute)
            return date.getTime()

            console.log(date);
        }

        function notifiSetAttendTime(send_time){
            setTimeout(function(){
                let notification = new Notification(
                    '勤之助リマインダー',
                    { body: "【出勤】出社予定時間が"+leave_time+"にセットされました!" }
                );
            }, 1500);
        }

        function notifiSetTime(time,status){
            setTimeout(function(){
                if( status =='leave'){
                    let notification = new Notification(
                        '勤之助リマインダー',
                        { body: "【退勤】退勤予定時間が"+time+"にセットされました!" }
                    );
                }

            }, 1500);
        }

        function remindLeaveTime(today_date,leave_time){
            setInterval(function(){
                if( today_date.getTime() == createDate(leave_time) ){
                    let notification = new Notification(
                        '勤之助リマインダー',
                        { body: "【退勤】退勤時間になります! タイムカードを打刻して下さい!" }
                    );
                    notification.onclick = function() {
                        shell.openExternal('https://www.4628.jp/?module=top&rd=1');
                    }
                }
            },1000);
        }
    </script>
</body>
</html>
