<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="style.css">
    <title>謹之助リマインダー</title>
</head>
<body>

  <div class="reminder" id="attend-reminder" title="【出勤】この時間になると通知がされます">
    <p class="reminder__title">出勤リマインド</p>
    <div class="reminder__form form">
      <input class="form__input" id="attend-time" type="time" value="10:00">
      <script>
        let attend_time = document.getElementById('attend-time');
        attend_time.addEventListener('focus', function(){
          document.body.classList.add('attend');
        });
        attend_time.addEventListener('blur', function(){
          document.body.classList.remove('attend');
        });
      </script>

      <button class="form__btn" id="attend-btn">決定</button>
      <script>
        let attend_btn = document.getElementById('attend-btn');
        attend_btn.addEventListener('click', function(){
          let leave_time = document.getElementById('attend-time').value;
          const ipcRenderer = require('electron').ipcRenderer;
          ipcRenderer.send('settings_attend_time', leave_time);
        });
      </script>
    </div>
  </div>
  <script>
      let attend_reminder = document.getElementById('attend-reminder');
      attend_reminder.addEventListener('click', function(){
          attend_time.focus();
      });
  </script>

  <div class="reminder" id="leave-reminder" title="【退勤】この時間になると通知がされます">
    <p class="reminder__title">退勤リマインド</p>
    <div class="reminder__form form">
      <input class="form__input" id="leave-time" type="time" value="19:00">
      <script>
          let leave_time = document.getElementById('leave-time');
          leave_time.addEventListener('focus', function(){
              document.body.classList.add('leave');
          });
          leave_time.addEventListener('blur', function(){
              document.body.classList.remove('leave');
          });
      </script>
      <button class="form__btn" id="leave-btn">決定</button>
      <script>
          let leave_btn = document.getElementById('leave-btn');
          leave_btn.addEventListener('click', function(){
              let leave_time = document.getElementById('leave-time').value;
              const ipcRenderer = require('electron').ipcRenderer;
              ipcRenderer.send('settings_leave_time', leave_time);

          });
      </script>
    </div>
  </div>
  <script>
    let leave_reminder = document.getElementById('leave-reminder');
    leave_reminder.addEventListener('click', function(){
      leave_time.focus();
    });
  </script>


    <script>
        'use script'

        // ライブラリの読み込み
        const electron = require('electron');
        const ipcRenderer = electron.ipcRenderer;
        const remote = electron.remote;
        const Menu = remote.Menu;
        const MenuItem = remote.MenuItem;
        const shell =remote.shell;

        // BackgroundColor処理
        let color = localStorage.getItem('color') || 'skyblue';
        setBackgroundColor(color);
        clickMenu();

        ipcRenderer.on('set_bgcolor', function(event, color){
            setBackgroundColor(color);
        });


        function clickMenu() {
            let menu = new Menu();
            menu.append(new MenuItem({label: 'Skyblue', click: function(){
                setBackgroundColor('skyblue');
            }}));
            menu.append(new MenuItem({label: 'Tomato', click: function(){
                setBackgroundColor('tomato');
            }}));
            menu.append(new MenuItem({label: 'Slate Gray', click: function(){
                setBackgroundColor('slategray');
            }}));

            window.addEventListener('contextmenu', function(e){
                e.preventDefault();
                // 右クリックでポップアップ表示させる。
                menu.popup(remote.getCurrentWindow());
            });
        }

       function setBackgroundColor(color) {
            document.body.style.backgroundColor = color;
            localStorage.setItem('color', color);
        }

        // リマインダー処理

        ipcRenderer.on('set_out_time', function(event, leave_time){
            let send_time = leave_time.split(':');
            let hour = send_time[0];
            let minute = send_time[1];
            let today_date = new Date();

            // 送らてきた時刻のフォーマット修正
            let leave_date = new Date();
            leave_date.setHours(hour);
            leave_date.setMinutes(minute)

            // 退勤リマインダー処理
            if( today_date.getTime() > leave_date.getTime() ){
                console.log('現在時刻よりも後ろは設定できないです。');
                let notification = new Notification(
                        '勤之助リマインダー',
                        { body: "【退勤】現在時刻よりも後ろは設定できないです。" }
                );
            } else {
                notifiSetLeaveTime();
                remindLeaveTime()
            }

            function remindLeaveTime(){
                setInterval(function(){
                    let remind_clok_out = leave_date.getTime()
                    if( today_date.getTime() == remind_clok_out ){
                        let notification = new Notification(
                            '勤之助リマインダー',
                            { body: "【退勤】退勤時間になります! タイムカードを打刻して下さい!" }
                        );
                        notification.onclick = function() {
                            shell.openExternal('https://www.4628.jp/?module=top&rd=1');
                        }
                    }
                },1000);
            }

            function notifiSetLeaveTime(){
                setTimeout(function(){
                    let notification = new Notification(
                        '勤之助リマインダー',
                        { body: "【退勤】退勤予定時間が"+leave_time+"にセットされました!" }
                    );
                }, 1500);
            }
        });

    </script>
    <div class="bg"></div>
</body>
</html>
